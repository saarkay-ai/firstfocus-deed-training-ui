<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Deed Training Platform</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #111827;
    }
    header {
      background: linear-gradient(90deg, #0ea5e9, #2563eb);
      color: white;
      padding: 12px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
    }
    .wrap {
      max-width: 1100px;
      margin: 20px auto;
      padding: 0 12px;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 16px 18px;
      box-shadow: 0 8px 20px rgba(15,23,42,0.08);
      margin-bottom: 16px;
    }
    .card h2 {
      margin-top: 0;
      font-size: 18px;
    }
    label {
      display: block;
      margin-top: 8px;
      font-size: 14px;
      color: #374151;
    }
    input, select {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 10px;
      margin-top: 4px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }
    button {
      border: 0;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      background: #2563eb;
      color: white;
      margin-top: 12px;
    }
    button.secondary {
      background: #6b7280;
    }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    @media (max-width: 900px) {
      .row {
        grid-template-columns: 1fr;
      }
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5e7eb;
      color: #374151;
      margin-left: 8px;
    }
    .muted {
      color: #6b7280;
      font-size: 13px;
    }
    hr {
      border: 0;
      border-top: 1px solid #e5e7eb;
      margin: 12px 0;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .tab-btn {
      border-radius: 999px;
      border: 0;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      background: #e5e7eb;
      color: #374151;
    }
    .tab-btn.active {
      background: #2563eb;
      color: white;
    }
    .tab-section {
      display: none;
    }
    .tab-section.active {
      display: block;
    }
    iframe {
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #111827;
    }
  </style>
</head>
<body>
  <header>
    <h1>Deed Training Platform</h1>
    <div id="userInfo" class="muted"></div>
  </header>

  <div class="wrap">

    <!-- LOGIN CARD -->
    <div id="loginCard" class="card">
      <h2>Login</h2>
      <label>Username</label>
      <input id="loginUsername" />

      <label>Password</label>
      <input id="loginPassword" type="password" />

      <button onclick="loginUser()">Login</button>
      <div class="muted" style="margin-top:8px;">Ask admin to create your account.</div>
    </div>

    <!-- MAIN APP WRAPPER -->
    <div id="appArea" style="display:none;">

      <!-- DASHBOARD / ROLE INFO -->
      <div class="card">
        <h2>Welcome <span id="dashUsername"></span>
          <span id="dashRole" class="badge"></span>
        </h2>
        <div id="dashStats" class="muted">You are now connected to the live backend.</div>
        <button class="secondary" onclick="logout()">Logout</button>
      </div>

      <div class="row">

        <!-- ADMIN PANEL -->
        <div id="adminPanel" class="card" style="display:none;">
          <h2>Admin – Create User</h2>
          <label>New Username</label>
          <input id="newUser" />

          <label>New Password</label>
          <input id="newPass" type="password" />

          <label>Role</label>
          <select id="newRole">
            <option value="trainee">Trainee</option>
            <option value="trainer">Trainer</option>
            <option value="admin">Admin</option>
          </select>

          <button onclick="createUserFromAdmin()">Create User</button>
          <div id="userCreateStatus" class="muted" style="margin-top:8px;"></div>
        </div>

        <!-- DEED UPLOAD (ADMIN / TRAINER) -->
        <div id="uploadPanel" class="card" style="display:none;">
          <h2>Upload Deed (PDF)</h2>
          <label>Select Deed PDF (single)</label>
          <input type="file" id="deedUploadInput" accept="application/pdf" />

          <label>Document Type</label>
          <select id="docType">
            <option value="">Select</option>
            <option>Warranty Deed</option>
            <option>Quitclaim Deed</option>
            <option>Deed of Trust</option>
            <option>Grant Deed</option>
          </select>

          <label>Grantor</label>
          <input id="grantor" />

          <label>Grantee</label>
          <input id="grantee" />

          <label>Recording Date</label>
          <input id="recordingDate" type="date" />

          <label>Dated Date</label>
          <input id="datedDate" type="date" />

          <button onclick="uploadDeedToBackend()">Upload & Save Deed</button>
          <div id="uploadStatus" class="muted" style="margin-top:8px;"></div>

          <hr />

          <h3 style="margin-top:8px;font-size:16px;">Upload ZIP (Multiple Deeds)</h3>
          <label>Select ZIP file containing many PDFs</label>
          <input type="file" id="zipUploadInput" accept=".zip,application/zip" />

          <button onclick="uploadZipOfDeeds()">Upload ZIP of Deeds</button>
          <div id="zipUploadStatus" class="muted" style="margin-top:8px;"></div>
        </div>

      </div>

      <!-- TRAINEE ATTEMPT WITH VIEWER + TABS -->
      <div id="traineePanel" class="card" style="display:none;">
        <h2>Trainee – Practice Capture</h2>
        <div class="muted">View the deed on the left and type the information on the right.</div>

        <div class="row" style="margin-top:12px; align-items:flex-start;">
          <!-- PDF VIEWER -->
          <div>
            <h3 style="margin-top:0;font-size:16px;">Deed Document</h3>
            <iframe id="deedViewer" style="width:100%;height:480px;"></iframe>
            <div class="muted" id="viewerHint" style="margin-top:6px;">
              Use “Get Next Deed Automatically” or enter Deed ID below and click “Load Deed for This ID”.
            </div>
          </div>

          <!-- FORM WITH TABS -->
          <div>
            <div class="tabs">
              <button class="tab-btn active" id="tabBtn-basic" onclick="showFormTab('basic')">Basic Info</button>
              <button class="tab-btn" id="tabBtn-county" onclick="showFormTab('county')">County Info</button>
              <button class="tab-btn" id="tabBtn-recording" onclick="showFormTab('recording')">Recording Info</button>
            </div>

            <label>Deed ID</label>
            <input id="attemptDeedId" />
            <button style="margin-top:6px;" onclick="loadDeedFromField()">Load Deed for This ID</button>
            <div id="nextDeedInfo" class="muted" style="margin-top:4px; margin-bottom:8px;"></div>

            <!-- BASIC TAB -->
            <div id="tab-basic" class="tab-section active">
              <label>Grantor</label>
              <input id="attemptGrantor" />

              <label>Grantee</label>
              <input id="attemptGrantee" />

              <label>Recording Date</label>
              <input id="attemptRecordingDate" type="date" />

              <label>Dated Date</label>
              <input id="attemptDatedDate" type="date" />

              <label>Document Type</label>
              <select id="attemptDocType">
                <option value="">Select</option>
                <option>Warranty Deed</option>
                <option>Quitclaim Deed</option>
                <option>Deed of Trust</option>
                <option>Grant Deed</option>
              </select>
            </div>

            <!-- COUNTY TAB -->
            <div id="tab-county" class="tab-section">
              <label>County Name</label>
              <input id="countyName" />

              <label>County State</label>
              <input id="countyState" />

              <label>APN (Assessor Parcel Number)</label>
              <input id="apn" />
            </div>

            <!-- RECORDING TAB -->
            <div id="tab-recording" class="tab-section">
              <label>Recording Book</label>
              <input id="recordingBook" />

              <label>Recording Page</label>
              <input id="recordingPage" />

              <label>Instrument Number</label>
              <input id="instrumentNumber" />
            </div>

            <button onclick="submitSimpleAttempt()">Submit Attempt</button>
            <div id="attemptStatus" class="muted" style="margin-top:8px;"></div>
          </div>
        </div>

        <button style="margin-top:12px;" onclick="getNextDeed()">Get Next Deed Automatically</button>
      </div>

    </div>
  </div>

  <script>
    const API_BASE = "https://firstfocus-deed-training-system1.onrender.com";

    let currentUser = null;
    let authToken = null;

    function showAppArea() {
      document.getElementById('loginCard').style.display = 'none';
      document.getElementById('appArea').style.display = 'block';

      document.getElementById('dashUsername').textContent = currentUser.username;
      document.getElementById('dashRole').textContent = currentUser.role;
      document.getElementById('userInfo').innerHTML =
        'Logged in as <strong>' + currentUser.username + '</strong>';

      const adminPanel = document.getElementById('adminPanel');
      const uploadPanel = document.getElementById('uploadPanel');
      const traineePanel = document.getElementById('traineePanel');

      adminPanel.style.display = 'none';
      uploadPanel.style.display = 'none';
      traineePanel.style.display = 'none';

      if (currentUser.role === 'admin') {
        adminPanel.style.display = 'block';
        uploadPanel.style.display = 'block';
        traineePanel.style.display = 'block';
      } else if (currentUser.role === 'trainer') {
        uploadPanel.style.display = 'block';
        traineePanel.style.display = 'block';
      } else if (currentUser.role === 'trainee') {
        traineePanel.style.display = 'block';
      }
    }

    function showLoginOnly() {
      document.getElementById('loginCard').style.display = 'block';
      document.getElementById('appArea').style.display = 'none';
      document.getElementById('userInfo').textContent = '';
    }

    async function loginUser() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      if (!username || !password) {
        alert('Enter username & password');
        return;
      }

      try {
        const res = await fetch(API_BASE + "/api/auth/login", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (!res.ok) {
          alert(data.error || 'Login failed');
          return;
        }

        currentUser = data.user;
        authToken = data.token;

        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        localStorage.setItem('authToken', authToken);

        showAppArea();
      } catch (err) {
        console.error(err);
        alert('Network error');
      }
    }

    function logout() {
      currentUser = null;
      authToken = null;
      localStorage.removeItem('currentUser');
      localStorage.removeItem('authToken');
      showLoginOnly();
    }

    async function createUserFromAdmin() {
      const u = document.getElementById('newUser').value.trim();
      const p = document.getElementById('newPass').value.trim();
      const role = document.getElementById('newRole').value;
      const statusEl = document.getElementById('userCreateStatus');

      if (!u || !p) {
        statusEl.textContent = 'Enter username and password';
        return;
      }

      if (!authToken) {
        statusEl.textContent = 'Not authenticated – please log in again.';
        return;
      }

      try {
        const res = await fetch(API_BASE + "/api/users", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + authToken
          },
          credentials: 'include',
          body: JSON.stringify({ username: u, password: p, role })
        });
        const data = await res.json();
        if (!res.ok) {
          statusEl.textContent = data.error || 'Error creating user';
          return;
        }
        statusEl.textContent =
          'User "' + data.user.username + '" created with role ' + data.user.role;
        document.getElementById('newUser').value = '';
        document.getElementById('newPass').value = '';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Network error';
      }
    }

    async function uploadDeedToBackend() {
      const fileInput = document.getElementById('deedUploadInput');
      const file = fileInput.files[0];
      const statusEl = document.getElementById('uploadStatus');
      statusEl.textContent = '';

      if (!file) {
        statusEl.textContent = 'Select a PDF file first.';
        return;
      }

      if (!authToken) {
        statusEl.textContent = 'Not authenticated – please log in again.';
        return;
      }

      const formData = new FormData();
      formData.append('deed', file);
      formData.append('document_type', document.getElementById('docType').value);
      formData.append('grantor', document.getElementById('grantor').value);
      formData.append('grantee', document.getElementById('grantee').value);
      formData.append('recording_date', document.getElementById('recordingDate').value);
      formData.append('dated_date', document.getElementById('datedDate').value);

      try {
        const res = await fetch(API_BASE + "/api/deeds/upload", {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Authorization': 'Bearer ' + authToken
          },
          body: formData
        });
        const data = await res.json();
        if (!res.ok) {
          statusEl.textContent = data.error || 'Upload failed';
          return;
        }
        statusEl.textContent = 'Deed uploaded with ID ' + data.deed.id;
        fileInput.value = '';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Network error';
      }
    }

    async function uploadZipOfDeeds() {
      const fileInput = document.getElementById('zipUploadInput');
      const file = fileInput.files[0];
      const statusEl = document.getElementById('zipUploadStatus');
      statusEl.textContent = '';

      if (!file) {
        statusEl.textContent = 'Select a ZIP file first.';
        return;
      }

      if (!authToken) {
        statusEl.textContent = 'Not authenticated – please log in again.';
        return;
      }

      const formData = new FormData();
      formData.append('zip', file);

      try {
        const res = await fetch(API_BASE + "/api/deeds/upload-zip", {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Authorization': 'Bearer ' + authToken
          },
          body: formData
        });
        const data = await res.json();
        if (!res.ok) {
          statusEl.textContent = data.error || 'ZIP upload failed';
          return;
        }
        statusEl.textContent =
          'Uploaded ' + data.count + ' deeds from ZIP.';
        fileInput.value = '';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Network error while uploading ZIP';
      }
    }

    function showFormTab(tab) {
      ['basic', 'county', 'recording'].forEach((t) => {
        const section = document.getElementById('tab-' + t);
        const btn = document.getElementById('tabBtn-' + t);
        if (t === tab) {
          section.classList.add('active');
          btn.classList.add('active');
        } else {
          section.classList.remove('active');
          btn.classList.remove('active');
        }
      });
    }

    async function getNextDeed() {
      const statusEl = document.getElementById('attemptStatus');
      const infoEl = document.getElementById('nextDeedInfo');
      statusEl.textContent = '';
      infoEl.textContent = '';

      if (!authToken) {
        statusEl.textContent = 'Not authenticated – please log in again.';
        return;
      }

      try {
        const res = await fetch(API_BASE + "/api/deeds/next", {
          method: 'GET',
          headers: {
            'Authorization': 'Bearer ' + authToken
          },
          credentials: 'include'
        });
        const data = await res.json();
        if (!res.ok) {
          statusEl.textContent = data.error || 'No more deeds available';
          return;
        }

        const deed = data.deed;
        document.getElementById('attemptDeedId').value = deed.id;
        infoEl.textContent =
          'Assigned Deed ID ' + deed.id +
          (deed.filename ? ' (' + deed.filename + ')' : '');

        await loadDeedForAttempt(deed.id, deed.filepath);
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Network error while fetching next deed';
      }
    }

    async function loadDeedForAttempt(deedId, knownFilepath) {
      const viewer = document.getElementById('deedViewer');
      const hint = document.getElementById('viewerHint');

      if (!authToken) {
        hint.textContent = 'Not authenticated – please log in again.';
        return;
      }

      try {
        let filepath = knownFilepath;

        if (!filepath) {
          const res = await fetch(API_BASE + "/api/deeds/" + deedId, {
            headers: { 'Authorization': 'Bearer ' + authToken },
            credentials: 'include'
          });
          const data = await res.json();
          if (!res.ok) {
            hint.textContent = data.error || 'Could not load deed';
            return;
          }
          filepath = data.deed.filepath;
        }

        if (!filepath) {
          hint.textContent = 'No PDF file path stored for this deed.';
          return;
        }

        const pdfUrl = API_BASE + "/uploads/deeds/" + filepath;
        viewer.src = pdfUrl;
        hint.textContent = 'Showing Deed ID ' + deedId + ' PDF.';
      } catch (err) {
        console.error(err);
        hint.textContent = 'Network error while loading deed.';
      }
    }

    function loadDeedFromField() {
      const idStr = document.getElementById('attemptDeedId').value.trim();
      const statusEl = document.getElementById('attemptStatus');
      statusEl.textContent = '';
      if (!idStr) {
        statusEl.textContent = 'Enter a Deed ID first.';
        return;
      }
      const deedId = parseInt(idStr, 10);
      if (!deedId) {
        statusEl.textContent = 'Deed ID must be a number.';
        return;
      }
      loadDeedForAttempt(deedId);
    }

    async function submitSimpleAttempt() {
      const statusEl = document.getElementById('attemptStatus');
      statusEl.textContent = '';

      if (!authToken) {
        statusEl.textContent = 'Not authenticated – please log in again.';
        return;
      }

      const deedId = document.getElementById('attemptDeedId').value.trim();
      if (!deedId) {
        statusEl.textContent = 'Enter a Deed ID (or click Get Next Deed).';
        return;
      }

      const body = {
        deed_id: parseInt(deedId, 10),
        grantor: document.getElementById('attemptGrantor').value,
        grantee: document.getElementById('attemptGrantee').value,
        recording_date: document.getElementById('attemptRecordingDate').value,
        dated_date: document.getElementById('attemptDatedDate').value,
        document_type: document.getElementById('attemptDocType').value,
        county_name: document.getElementById('countyName').value,
        county_state: document.getElementById('countyState').value,
        apn: document.getElementById('apn').value,
        recording_book: document.getElementById('recordingBook').value,
        recording_page: document.getElementById('recordingPage').value,
        instrument_number: document.getElementById('instrumentNumber').value,
        total_score: 0,
        time_taken_seconds: 0,
        feedback: null
      };

      try {
        const res = await fetch(API_BASE + "/api/attempts", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + authToken
          },
          credentials: 'include',
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) {
          statusEl.textContent = data.error || 'Failed to save attempt';
          return;
        }
        statusEl.textContent = 'Attempt saved!';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Network error';
      }
    }

    (function init() {
      const storedUser = localStorage.getItem('currentUser');
      const storedToken = localStorage.getItem('authToken');
      if (storedUser && storedToken) {
        try {
          currentUser = JSON.parse(storedUser);
          authToken = storedToken;
          showAppArea();
        } catch {}
      }
    })();
  </script>
</body>
</html>